Домашнее задание по настройке бэкапа с помощью BORG

После попытки ручного прогона по методичке, выяснилось, что не хватало нескольких команд на сервере backup после генерации ключей ssh на клиенте:

На сервере backup нужно было сделать еще:

echo 'command="/usr/bin/borg serve" ssh-rsa public_key' >> ~borg/.ssh/authorized_keys

chown -R borg:borg ~borg/.ssh

После этого стало возможно авторизоваться без пароля на сервере бэкапа

Так же, после создания сервиса borg-backup, нужно было сделать еще две команды:

systemctl daemon-reload

systemctl start borg-backup

Без этого таймер не запускался



Логгирование

Конфигурируется переменной BORG_LOGGING_CONF, которую нужно прописать в файле конфигурации сервиса

/etc/systemd/system/borg-backup.service и в ней указать на файл, который будет содержать конфиуграцию

Environment=BORG_LOGGING_CONF=/root/.config/borg/borg_log.conf

А в нем уже настроить все необходимые параметры

Автоматизация написана мной без Ansible, но лишь средствами Vagrant с использованием дополнительной утилиты sshpass на клиенте - она позволяет выполнять подключение по shh без ручного ввода пароля. Я его прописал в переменной окружения SSHPASS

Пара ключей генерируется на клиете командой ssh-keygen -f /root/.ssh/id_rsa -q -N "" без ручного ввода

После этого необходимые команды для записи открытого ключа и выставления прав на каталоги выполняются на сервере бэкапа через sshpass в автоматическом режиме

Лог успешного бэкапа прилагается